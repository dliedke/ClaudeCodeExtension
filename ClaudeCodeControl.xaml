<UserControl x:Class="ClaudeCodeVS.ClaudeCodeControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:wf="clr-namespace:System.Windows.Forms.Integration;assembly=WindowsFormsIntegration"
             xmlns:vsshell="clr-namespace:Microsoft.VisualStudio.Shell;assembly=Microsoft.VisualStudio.Shell.15.0"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="400"
             Background="{DynamicResource {x:Static vsshell:VsBrushes.WindowKey}}"
             Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}">

	<UserControl.Resources>
		<!-- Single border GroupBox style -->
		<Style x:Key="SingleBorderGroupBoxStyle" TargetType="GroupBox">
			<Setter Property="Padding" Value="3"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="GroupBox">
						<Grid>
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="*"/>
							</Grid.RowDefinitions>

							<!-- Border around content -->
							<Border Grid.Row="0" Grid.RowSpan="2"
							        BorderBrush="{TemplateBinding BorderBrush}"
							        BorderThickness="{TemplateBinding BorderThickness}"
							        Background="{TemplateBinding Background}"
							        CornerRadius="4">
							</Border>

							<!-- Header with background to cover border -->
							<Border Grid.Row="0"
							        Background="{TemplateBinding Background}"
							        Margin="8,0,0,0"
							        HorizontalAlignment="Left">
								<ContentPresenter ContentSource="Header"
								                  RecognizesAccessKey="True"
								                  Margin="4,0"/>
							</Border>

							<!-- Content -->
							<ContentPresenter Grid.Row="1"
							                  Margin="{TemplateBinding Padding}"/>
						</Grid>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<!-- Adaptive button style for light/dark theme -->
		<Style x:Key="AdaptiveButtonStyle" TargetType="Button">
			<Setter Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"/>
			<Setter Property="Foreground" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowTextKey}}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="Padding" Value="8,5"/>
			<Setter Property="Height" Value="30"/>
			<Setter Property="Cursor" Value="Hand"/>
			<Setter Property="Focusable" Value="False"/>
			<Setter Property="SnapsToDevicePixels" Value="True"/>
			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="Button">
						<Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
							<ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
						<ControlTemplate.Triggers>
							<Trigger Property="IsMouseOver" Value="True">
								<Setter Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarHoverOverSelectedKey}}"/>
								<Setter Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedBorderKey}}"/>
							</Trigger>
							<Trigger Property="IsPressed" Value="True">
								<Setter Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedKey}}"/>
								<Setter Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.CommandBarSelectedBorderKey}}"/>
							</Trigger>
							<Trigger Property="IsEnabled" Value="False">
								<Setter Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"/>
								<Setter Property="Foreground" Value="{DynamicResource {x:Static vsshell:VsBrushes.GrayTextKey}}"/>
								<Setter Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}"/>
							</Trigger>
						</ControlTemplate.Triggers>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<!-- Small "chip" for attached files -->
		<Style x:Key="ChipBorder" TargetType="Border">
			<Setter Property="Background" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"/>
			<Setter Property="CornerRadius" Value="10"/>
			<Setter Property="Padding" Value="5,1"/>
			<Setter Property="Margin" Value="0,2,4,0"/>
			<Setter Property="BorderBrush" Value="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}"/>
			<Setter Property="BorderThickness" Value="1"/>
			<Setter Property="Height" Value="22"/>
		</Style>

		<Style x:Key="ChipRemoveButton" TargetType="Button" BasedOn="{StaticResource AdaptiveButtonStyle}">
			<Setter Property="Width" Value="14"/>
			<Setter Property="Height" Value="14"/>
			<Setter Property="Padding" Value="0"/>
			<Setter Property="Margin" Value="4,0,0,0"/>
			<Setter Property="Content" Value="Ã—"/>
			<Setter Property="FontWeight" Value="Bold"/>
			<Setter Property="FontSize" Value="10"/>
		</Style>

		<!-- Small button style for provider selection -->
		<Style x:Key="ProviderButtonStyle" TargetType="Button" BasedOn="{StaticResource AdaptiveButtonStyle}">
			<Setter Property="FontSize" Value="10"/>
			<Setter Property="Height" Value="22"/>
			<Setter Property="Padding" Value="8,3"/>
			<Setter Property="Margin" Value="2"/>
			<Setter Property="MinWidth" Value="80"/>
		</Style>

		<!-- Gray gear button style -->
		<Style x:Key="GrayGearButtonStyle" TargetType="Button" BasedOn="{StaticResource AdaptiveButtonStyle}">
			<Setter Property="Foreground" Value="Gray"/>
		</Style>
	</UserControl.Resources>

	<Grid x:Name="MainGrid">
		<Grid.RowDefinitions>
			<RowDefinition Height="*" MinHeight="80"/>
			<RowDefinition Height="4"/>
			<RowDefinition Height="2*" MinHeight="150"/>
		</Grid.RowDefinitions>

		<!-- Top Section Container -->
		<Grid Grid.Row="0" Margin="6,6,6,0">
			<Grid.RowDefinitions>
				<RowDefinition Height="*" MinHeight="80"/>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="Auto"/>
			</Grid.RowDefinitions>

			<!-- Prompt Input Area -->
			<GroupBox Grid.Row="0"
                      Header="Prompt / Paste Image"
                      Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                      Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"
                      BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                      BorderThickness="1"
                      Margin="0,0,0,2"
                      Style="{StaticResource SingleBorderGroupBoxStyle}">
				<TextBox x:Name="PromptTextBox"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"
                         FontFamily="Cascadia Mono"
                         Background="{DynamicResource {x:Static vsshell:VsBrushes.WindowKey}}"
                         Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                         BorderBrush="Transparent"
                         BorderThickness="0"
                         KeyDown="PromptTextBox_KeyDown"
                         PreviewKeyDown="PromptTextBox_PreviewKeyDown">
					<TextBox.ContextMenu>
						<ContextMenu>
							<MenuItem Header="Clear Prompt History" Click="ClearPromptHistoryMenuItem_Click"/>
						</ContextMenu>
					</TextBox.ContextMenu>
				</TextBox>
			</GroupBox>

			<!-- Controls row: [Send + Add Image] | [Chips] | [Restart (right-aligned)] -->
			<Grid Grid.Row="1" Margin="0,4,0,0" VerticalAlignment="Top">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="Auto"/>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>

				<!-- Left cluster -->
				<StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Top">
					<!-- Send button (visible only when Send-with-Enter is off) -->
					<Button x:Name="SendPromptButton"
                            Content="Send"
							Width="50"
                            MinWidth="50"
                            Style="{StaticResource AdaptiveButtonStyle}"
                            Click="SendButton_Click"
                            Visibility="Collapsed"
                            ToolTip="Send Prompt to Code Agent"
                            Margin="0,0,8,0"/>

					<!-- Fixed-width Add File so it never expands with chips -->
					<Button x:Name="AddImageButton"
                            Content="Add File"
                            Style="{StaticResource AdaptiveButtonStyle}"
                            Width="80"
                            MinWidth="80"
                            HorizontalAlignment="Left"
                            ToolTip="Add Files to Prompt (Images, PDFs, Documents, etc.)"
                            PreviewMouseLeftButtonUp="ImageDropBorder_Click"/>
				</StackPanel>

				<!-- Chips in their own stretch area so they don't affect button sizing -->
				<ScrollViewer Grid.Column="1"
                              VerticalScrollBarVisibility="Disabled"
                              HorizontalScrollBarVisibility="Auto"
                              Margin="8,0,12,0">
					<WrapPanel x:Name="AttachedImagesPanel" />
				</ScrollViewer>

                <!-- Right-aligned buttons (Restart + Model + Settings + Update) -->
				<StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="6,0,0,0">


					<Button x:Name="ViewChangesButton"
                            Content="Changes"
                            Width="65"
                            MinWidth="65"
                            Style="{StaticResource AdaptiveButtonStyle}"
                            Click="ViewChangesButton_Click"
                            ToolTip="View Code Changes"
                            Margin="0,0,6,0"/>

					<Button x:Name="RestartTerminalButton"
                            Content="Restart"
                            Width="60"
                            MinWidth="60"
                            Style="{StaticResource AdaptiveButtonStyle}"
                            Click="RestartTerminalButton_Click"
                            ToolTip="Restart Code Agent"
                            Margin="0,0,6,0"/>

					<Button x:Name="ModelDropdownButton"
                            Content="ðŸ¤–"
                            Width="30"
                            Height="30"
                            FontSize="14"
                            Style="{StaticResource GrayGearButtonStyle}"
                            FontFamily="Consolas"
                            ToolTip="Claude Model Selection"
                            Click="ModelDropdownButton_Click"
                            Margin="0,0,6,0">
						<Button.ContextMenu>
							<ContextMenu x:Name="ModelContextMenu">
								<MenuItem Header="Opus - Complex tasks" x:Name="OpusMenuItem" Click="OpusMenuItem_Click" IsCheckable="True"/>
								<MenuItem Header="Sonnet - Everyday tasks" x:Name="SonnetMenuItem" Click="SonnetMenuItem_Click" IsCheckable="True" IsChecked="True"/>
								<MenuItem Header="Haiku - Easy tasks" x:Name="HaikuMenuItem" Click="HaikuMenuItem_Click" IsCheckable="True"/>
							</ContextMenu>
						</Button.ContextMenu>
					</Button>
					<Button x:Name="MenuDropdownButton"
                            Content="âš™"
                            Width="30"
                            Height="30"
                            FontSize="14"
                            Style="{StaticResource GrayGearButtonStyle}"
                            FontFamily="Consolas"
                            ToolTip="Code Agent Selection"
                            Click="MenuDropdownButton_Click"
                            Margin="0,0,6,0">
						<Button.ContextMenu>
							<ContextMenu x:Name="ProviderContextMenu" Opened="ProviderContextMenu_Opened">
								<MenuItem Header="Claude Code" x:Name="ClaudeCodeMenuItem" Click="ClaudeCodeMenuItem_Click" IsCheckable="True" IsChecked="True"/>
								<MenuItem Header="Claude Code (WSL)" x:Name="ClaudeCodeWSLMenuItem" Click="ClaudeCodeWSLMenuItem_Click" IsCheckable="True"/>
								<MenuItem Header="Codex" x:Name="CodexMenuItem" Click="CodexMenuItem_Click" IsCheckable="True"/>
								<MenuItem Header="Cursor Agent" x:Name="CursorAgentMenuItem" Click="CursorAgentMenuItem_Click" IsCheckable="True"/>
								<MenuItem Header="Open Code" x:Name="OpenCodeMenuItem" Click="OpenCodeMenuItem_Click" IsCheckable="True"/>
								<MenuItem Header="Qwen Code" x:Name="QwenCodeMenuItem" Click="QwenCodeMenuItem_Click" IsCheckable="True"/>
								<Separator x:Name="AutoOpenChangesSeparator"/>
								<MenuItem Header="Auto-open Changes on Send" x:Name="AutoOpenChangesMenuItem" Click="AutoOpenChangesMenuItem_Click" IsCheckable="True" ToolTip="Automatically open Changes view, expand files, and enable auto-scroll when a prompt is sent"/>
								<Separator/>
								<MenuItem Header="About" x:Name="AboutMenuItem" Click="AboutMenuItem_Click"/>
							</ContextMenu>
						</Button.ContextMenu>
					</Button>
                    <Button x:Name="UpdateAgentButton"
						Content="ðŸ”„ï¸"
						Width="30"
						MinWidth="30"
						Style="{StaticResource AdaptiveButtonStyle}"
						Click="UpdateAgentButton_Click"
						ToolTip="Update Code Agent"
						Margin="0"/>
				</StackPanel>
			</Grid>

			<!-- Send with Enter toggle -->
			<CheckBox Grid.Row="2"
                      x:Name="SendWithEnterCheckBox"
                      Content="Send with Enter"
                      IsChecked="True"
                      Foreground="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowTextKey}}"
                      Margin="0,6,0,6"
                      ToolTip="Automatically send prompt to code agent with enter key. Use Shift+Enter for new lines"
                      Checked="SendWithEnterCheckBox_Checked"
                      Unchecked="SendWithEnterCheckBox_Unchecked"/>
		</Grid>

		<!-- Resizable Splitter -->
		<GridSplitter x:Name="MainGridSplitter"
                      Grid.Row="1"
                      Height="4"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Center"
                      Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBorderKey}}"
                      ShowsPreview="True"
                      ResizeDirection="Rows"
                      ResizeBehavior="PreviousAndNext"
                      Cursor="SizeNS"
                      DragCompleted="MainGridSplitter_DragCompleted"/>

		<!-- Embedded Terminal -->
		<GroupBox Grid.Row="2"
                  Header="Claude Code"
                  Margin="6"
                  Foreground="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                  Background="{DynamicResource {x:Static vsshell:VsBrushes.ToolWindowBackgroundKey}}"
                  BorderBrush="{DynamicResource {x:Static vsshell:VsBrushes.WindowTextKey}}"
                  BorderThickness="1"
                  Style="{StaticResource SingleBorderGroupBoxStyle}"
                  x:Name="TerminalGroupBox">
			<wf:WindowsFormsHost x:Name="TerminalHost"/>
		</GroupBox>
	</Grid>
</UserControl>
